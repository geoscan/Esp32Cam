//
// Aggregate.impl
//
// Created on: Dec 23, 2021
//     Author: Dmitry Murashov (d.murashov@geoscan.aero)
//

#include "Mavlink.hpp"
#include "Aggregate.hpp"

template <class ...Tmics>
Mav::Mic::Aggregate<Tmics...>::Aggregate(DelayedSendHandle &aHandle) :
	microservices{{std::unique_ptr<Microservice>{new Tmics}...}}
{
	using List = int[];
	int cnt = 0;
	List{(void(delayedSendInit(&aHandle, static_cast<Tmics *>(microservices[cnt++].get()))), 0)...};
}

template <class ...Tmics>
Mav::Microservice::Ret Mav::Mic::Aggregate<Tmics...>::process(mavlink_message_t &aMessage,
	OnResponseSignature aOnResponse)
{
	for (auto &ptrMicroservice : microservices) {
		auto ret = ptrMicroservice->process(aMessage, aOnResponse);

		if (ret != Ret::Ignored) {
			return ret;
		}
	}

	return Ret::Ignored;
}
